{% load static %}
<!DOCTYPE html>
<html lang="en">
{% block head %}
<head>
  <meta charset="UTF-8" />
  <title>Media Journal</title>
  <link rel="stylesheet" href="{% static 'core/css/header.css' %}" />
  <link rel="stylesheet" href="{% static 'core/css/search.css' %}" />
  <link rel="icon" href="/static/core/icons/favicon.ico" type="image/x-icon">
</head>
{% endblock %}

<body>
  {% include "core/header.html" %}

  <main>
    {% block content %}{% endblock %}
  </main>

<!-- Search overlay container -->
<div id="search-overlay" class="hidden">
  <div id="search-results-panel" tabindex="0">
    <div class="overlay-search-bar">
      <div class="overlay-search-input-wrapper">
        {% with page_type|lower as page %}
          {% if page == "tv" %}
            <input type="text" id="overlay-search-input" placeholder="Search for a TV show.." autocomplete="off">
          {% else %}
            {% with page|first as first_letter %}
              {% if first_letter in "aeiou" %}
                {% with article="an" %}
                  <input type="text" id="overlay-search-input"
                         placeholder="Search for {{ article }} {{ page }}.." autocomplete="off">
                {% endwith %}
              {% else %}
                {% with article="a" %}
                  <input type="text" id="overlay-search-input"
                         placeholder="Search for {{ article }} {{ page }}.." autocomplete="off">
                {% endwith %}
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endwith %}

        <label class="live-search-label">
          <input type="checkbox" id="live-search-toggle"> Live Search
        </label>
      </div>
    </div>

    <div id="search-results"></div>
  </div>
</div>


  {% block script %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const overlay = document.getElementById("search-overlay");
      const overlaySearchInput = document.getElementById("overlay-search-input");
      const resultsContainer = document.getElementById("search-results");
      const liveSearchToggle = document.getElementById("live-search-toggle");
      const openSearchBtn = document.getElementById("search-open-btn");
      const pageType = "{{ page_type }}";

      if (openSearchBtn) {
        openSearchBtn.addEventListener("click", () => {
          overlay.classList.remove("hidden");
          overlaySearchInput.value = "";
          overlaySearchInput.focus();
        });
      }

      function debounce(func, wait = 300) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      const apiEndpoints = {
        movie: "/api/tmdb_search/",
        tv: "/api/tmdb_search/",
        anime: "/api/mal_search/",
        manga: "/api/mal_search/",
        game: "/api/igdb_search/",
      };

      async function doSearch(query) {
        if (!query.trim()) {
          resultsContainer.innerHTML = "";
          overlay.classList.add("hidden");
          return;
        }

        const endpoint = apiEndpoints[pageType] || "/api/tmdb_search/";

        try {
          const params = new URLSearchParams();
          params.append("q", query);
          if (["anime", "manga", "movie", "tv"].includes(pageType)) {
            params.append("type", pageType);
          }

          const url = endpoint + "?" + params.toString();
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network error");

          const data = await response.json();
          if (!data.results || data.results.length === 0) {
            resultsContainer.innerHTML = "<div style='color:#eee; text-align:center;'>No results found</div>";
            overlay.classList.remove("hidden");
            return;
          }

          const cardsHtml = data.results.map(item => {
            const title = item.title || item.name || "Untitled";
            let poster = "{% static 'core/img/placeholder.png' %}";

            if ((pageType === "movie" || pageType === "tv") && item.poster_path) {
              poster = `https://image.tmdb.org/t/p/w200${item.poster_path}`;
            } else if (item.poster_path) {
              poster = item.poster_path;
            }

            const prefix = pageType === "anime" || pageType === "manga" ? "mal" :
                           pageType === "game" ? "igdb" : "tmdb";

            return `
              <div class="search-card">
                <a href="/${prefix}/${pageType}/${item.id}" class="card-link">
                  <img src="${poster}" alt="${title}" />
                  <div class="search-card-title">${title}</div>
                </a>
              </div>`;
          }).join("");

          resultsContainer.innerHTML = `<div class="search-card-grid">${cardsHtml}</div>`;
          overlay.classList.remove("hidden");
          overlaySearchInput.focus();

        } catch (error) {
          resultsContainer.innerHTML = `<div style="color:#eee; text-align:center;">Error fetching results</div>`;
          overlay.classList.remove("hidden");
          console.error("Search error:", error);
        }
      }

      const liveSearchHandler = debounce(e => {
        doSearch(e.target.value);
      });

      overlaySearchInput.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          doSearch(e.target.value);
        }
      });

      overlaySearchInput.addEventListener("input", e => {
        if (liveSearchToggle && liveSearchToggle.checked) {
          liveSearchHandler(e);
        } else {
          resultsContainer.innerHTML = "";
        }
      });

      // Close overlay if clicked outside panel
      overlay.addEventListener("click", e => {
        if (e.target === overlay) {
          overlay.classList.add("hidden");
          resultsContainer.innerHTML = "";
        }
      });

      // Close overlay on Escape key
      document.addEventListener("keydown", e => {
        if (e.key === "Escape" && !overlay.classList.contains("hidden")) {
          overlay.classList.add("hidden");
          resultsContainer.innerHTML = "";
        }
      });
    });
  </script>
  {% endblock %}
</body>
</html>

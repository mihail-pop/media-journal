{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'core/css/history.css' %}?v={{ version }}">
<link rel="stylesheet" href="{% static 'core/css/modal.css' %}?v={{ version }}">
{% endblock %}

{% block content %}
<body data-media-type="history"></body>
<div class="separator-bar"></div>
<div class="list-page-container">
<aside class="sidebar">
  <input type="text" id="search-input" placeholder="Filter" autocomplete="off">

  <h3>Sort</h3>
  <div class="sort-filter filter-group">
    <button id="sort-asc" class="filter-btn sort-btn">Ascending</button>
    <button id="sort-desc" class="filter-btn sort-btn active">Descending</button>
  </div>

  <h3>Year & Month</h3>
  <div class="year-filter filter-group">
    <button class="filter-btn year-btn" data-year="all">All</button>
    {% for year in latest_years %}
    <button class="filter-btn year-btn" data-year="{{ year }}">{{ year }}</button>
    {% endfor %}
    <input type="number" id="custom-year" placeholder="Year" min="1900" max="2100">
  </div>

  <div id="month-filter" class="month-filter filter-group" style="display:none;">
    <button class="filter-btn month-btn" data-month="1">Jan</button>
    <button class="filter-btn month-btn" data-month="2">Feb</button>
    <button class="filter-btn month-btn" data-month="3">Mar</button>
    <button class="filter-btn month-btn" data-month="4">Apr</button>
    <button class="filter-btn month-btn" data-month="5">May</button>
    <button class="filter-btn month-btn" data-month="6">Jun</button>
    <button class="filter-btn month-btn" data-month="7">Jul</button>
    <button class="filter-btn month-btn" data-month="8">Aug</button>
    <button class="filter-btn month-btn" data-month="9">Sep</button>
    <button class="filter-btn month-btn" data-month="10">Oct</button>
    <button class="filter-btn month-btn" data-month="11">Nov</button>
    <button class="filter-btn month-btn" data-month="12">Dec</button>
  </div>

  <h3 class="date-range-title">Date Range</h3>
  <div class="date-range-filter filter-group">
    <input type="date" id="start-date">  <input type="date" id="end-date"> 
  </div>

  <h3>Type</h3>
  <div class="type-filter filter-group">
    <button class="filter-btn type-btn" data-type="all">All</button>
    <button class="filter-btn type-btn" data-type="movie">Movie</button>
    <button class="filter-btn type-btn" data-type="tv">TV Show</button>
    <button class="filter-btn type-btn" data-type="anime">Anime</button>
    <button class="filter-btn type-btn" data-type="manga">Manga</button>
    <button class="filter-btn type-btn" data-type="game">Game</button>
    <button class="filter-btn type-btn" data-type="book">Book</button>
  </div>

  <h3>Status</h3>
  <div class="status-filter filter-group">
    <button class="filter-btn status-btn" data-status="all">All</button>
    <button class="filter-btn status-btn" data-status="completed">Completed</button>
    <button class="filter-btn status-btn" data-status="ongoing">Ongoing</button>
    <button class="filter-btn status-btn" data-status="planned">Planned</button>
    <button class="filter-btn status-btn" data-status="on_hold">On Hold</button>
    <button class="filter-btn status-btn" data-status="dropped">Dropped</button>
  </div>
</aside>


<section class="list-content">
  <p id="no-items-message" class="hidden-items">No items found.</p>
  <!-- Explicit override so history always shows cards -->
  <div id="card-view" class="card-grid" style="display:grid;">
    {% for item in items %}
    <div class="card"
         data-id="{{ item.id }}"
         data-media-type="{{ item.media_type }}"
         data-title="{{ item.title|escape }}"
         data-date="{{ item.date_added|date:'Y-m-d' }}"
         data-month="{{ item.date_added|date:'m' }}"
         data-year="{{ item.date_added|date:'Y' }}"
         data-status="{{ item.status }}"
         data-cover-url="{{ item.cover_url|default:'/static/core/img/placeholder.png' }}"
         data-banner-url="{{ item.banner_url|default:'/static/core/img/placeholder.png' }}">

      {% if item.media_type == "movie" or item.media_type == "tv" %}
        <a href="{% if '_s' in item.source_id %}/tmdb/season/{% with parts=item.source_id|split:'_s' %}{{ parts.0 }}/{{ parts.1 }}/{% endwith %}{% else %}{% url 'tmdb_detail' media_type=item.media_type tmdb_id=item.source_id %}{% endif %}" class="card-link">
      {% elif item.media_type == "anime" or item.media_type == "manga" %}
        <a href="{% url 'mal_detail' media_type=item.media_type mal_id=item.source_id %}" class="card-link">
      {% elif item.media_type == "book" %}
        <a href="{% url 'openlib_detail' work_id=item.source_id %}" class="card-link">
      {% elif item.media_type == "game" %}
        <a href="{% url 'igdb_detail' igdb_id=item.source_id %}" class="card-link">
      {% else %}
        <a href="#" class="card-link">
      {% endif %}

          <div class="card-image">
            <img src="{{ item.cover_url|default:'/static/core/img/placeholder.png' }}" alt="{{ item.title }}" loading="lazy">
          </div>
          <div class="card-title-overlay">
            <span class="card-title">{{ item.title }}</span>
<div class="card-subtitle">
  {% if item.status == "on_hold" %}
    Paused {{ item.date_added|timesince_one_unit }}
  {% elif item.status == "ongoing" %}
    Started {{ item.date_added|timesince_one_unit }}
  {% else %}
    {{ item.status|capfirst }} {{ item.date_added|timesince_one_unit }}
  {% endif %}
</div>
            <div class="card-date">
              {{ item.date_added|date:"d M Y" }}
            </div>
          </div>
        </a>

        <!-- Status bar -->
        <div class="status-overlay status-{{ item.status }}"></div>

        <button class="edit-card-btn">â‹¯</button>
    </div>
    {% endfor %}
  </div>
</section>
</div>
{% include 'core/partials/edit_modal.html' %}
{% endblock %}

{% block script %}
<script>
  document.body.setAttribute('data-theme', '{{ theme_mode }}');
</script>
<script src="{% static 'core/js/edit_modal.js' %}?v={{ version }}"></script>
<script src="{% static 'core/js/history.js' %}?v={{ version }}"></script>
{% endblock %}

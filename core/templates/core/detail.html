{% extends "core/base.html" %}
{% load static %}

{% block head %}
  {{ block.super }}
  <title>{{ title }} - Media Journal</title>
  <link rel="stylesheet" href="{% static 'core/css/detail.css' %}?v={{ version }}" />
  <link rel="stylesheet" href="{% static 'core/css/modal.css' %}?v={{ version }}" />
{% endblock %}

{% block content %}
<script>
  document.body.dataset.theme = '{{ theme_mode }}';
  document.body.dataset.mediaType = '{{ media_type }}';
  document.body.dataset.itemId = '{{ source_id }}';
</script>

{% with banner=banner_url|default_if_none:'' %}
  <div class="banner-section {% if not banner %}no-banner{% endif %}"
       {% if banner %}data-banner="{{ banner_url}}"{% endif %}>
    <div class="banner-overlay"></div>
  </div>
{% if not recommendations %}
<button onclick="openCoverUpload('{{ source }}', '{{ source_id }}')" class="change-cover-btn">
  Change Cover
</button>
  <button onclick="openBannerUpload('{{ source }}', '{{ source_id }}')"
        class="change-banner-btn">
  Change Banner
</button>
<button onclick="refreshItem('{{ item_id }}')" class="refresh-btn">
  Refresh Data
</button>
{% endif %}
{% endwith %}

<!-- Colored section below banner -->
<div class="top-colored-section">
  <div class="detail-container top-content">

  <div class="left-column">
    <!-- Poster -->
<img class="poster" 
     src="{{ poster_url }}" 
     alt="{{ title }}" 
     data-placeholder="{% static 'core/img/placeholder.png' %}" 
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
    
    <!-- Edit / Favorite buttons -->
    <div class="edit-favorite-wrapper">
      {% if in_my_list %}
        <button id="edit-button" class="btn edit-card-btn" data-id="{{ item_id }}" data-media-type="{{ media_type }}" data-source-id="{{ source_id }}">Edit</button>
        <form id="favorite-form" data-item-id="{{ item_id }}">
          <label class="favorite-checkbox">
            <input type="checkbox" name="favorite" {% if item.favorite %}checked{% endif %}>
            <span class="heart"></span>
          </label>
        </form>
      {% else %}
        <button id="add-to-list-button" class="btn"
          data-source="{{ source }}"
  data-source-id="{{ source_id }}"
  data-media-type="{{ media_type }}"
  data-title="{{ title }}"
  data-cover-url="{{ cover_url }}">Add to My List</button>
      {% endif %}
    </div>
  </div>

<div class="right-column">
  <div class="text-info">
    <h1>{{ title }}</h1>
    <div class="overview-container">
      <p class="overview">{{ overview|safe }}</p>
      <button class="read-more-btn">Read More</button>
    </div>
    <p class="release-date">{{ release_date }}</p>

    <!-- More info button -->
    {% if media_type != "book" %}
    <button id="more-info-btn" class="more-info-btn">More information</button>
    {% endif %}
    <!-- Container for extra info -->
    <div id="extra-info-container" style="margin-top:0.5em;"></div>
  </div>
</div>
  </div>
 </div>
</div>


{% include "core/partials/edit_modal.html" with media_type=media_type item_id=item_id status=item.status personal_rating=item.personal_rating notes=item.notes progress_main=item.progress_main total_main=item.total_main progress_secondary=item.progress_secondary total_secondary=item.total_secondary favorite=item.favorite item_status_choices=item_status_choices item_rating_choices=item_rating_choices %}

<!-- Main background section -->
<div class="main-colored-section">
  <div class="detail-container">
    <div id="trailer-container" class="trailer-grid"></div>
    {% if prequels or sequels %}
    <section class="recommendations-section double-recs">
      {% if prequels %}
      <div class="rec-block">
        <h2>Prequel</h2>
        <div class="recommendations-list">
          {% for rec in prequels %}
          <a href="/mal/{{ media_type }}/{{ rec.id }}/" class="rec-card" title="{{ rec.title }}">
            <img src="{{ rec.poster_path }}"
     alt="{{ rec.title }}"
     data-placeholder="{% static 'core/img/placeholder.png' %}"
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
            <p class="rec-title">{{ rec.title }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if sequels %}
      <div class="rec-block">
        <h2>Sequel</h2>
        <div class="recommendations-list">
          {% for rec in sequels %}
          <a href="/mal/{{ media_type }}/{{ rec.id }}/" class="rec-card" title="{{ rec.title }}">
            <img src="{{ rec.poster_path }}" 
     alt="{{ rec.title }}" 
     data-placeholder="{% static 'core/img/placeholder.png' %}" 
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
            <p class="rec-title">{{ rec.title }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </section>
    {% endif %}

    {% if seasons %}
    <section class="seasons-section">
      <h2>Seasons</h2>
      <div class="seasons-list">
        {% for season in seasons %}
        <a href="/tmdb/season/{{ source_id }}/{{ season.season_number }}/" class="season-card">
  <img 
    src="{{ season.poster_path_full|default:'' }}"
    alt="{{ season.name }}"
    data-placeholder="{% static 'core/img/placeholder.png' %}"
    onerror="this.onerror=null;this.src=this.dataset.placeholder;"
  />
          <p class="season-name">{{ season.name }}</p>
          <p class="episode-count">{{ season.episode_count }} episodes</p>
          <p class="air-date">{{ season.air_date }}</p>
        </a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

{{ screenshots|json_script:"screenshots-data" }}

{% if media_type == 'game' %}
<section class="screenshots-section">
  <div class="screenshots-header">
  <h2>Screenshots</h2>
{% if not recommendations %}
  <!-- Upload Form -->
   <div class="screenshots-header-buttons">
  <form id="screenshot-upload-form" enctype="multipart/form-data" class="inline-form">
    <input type="hidden" name="igdb_id" value="{{ source_id }}">
    <input type="file" id="screenshot-file-input" name="screenshots[]" accept=".jpg,.jpeg,.png" multiple hidden>
    <button type="button" id="swap-btn">
      Swap
    </button>
  </form>

  <!-- Add Form (add to existing) -->
<form id="screenshot-add-form" enctype="multipart/form-data" class="inline-form">
  <input type="hidden" name="igdb_id" value="{{ source_id }}">
  <input type="file" id="screenshot-add-file-input" name="screenshots[]" accept=".jpg,.jpeg,.png" multiple hidden>
  <button type="button" onclick="document.getElementById('screenshot-add-file-input').click();">
    Add
  </button>
</form>
</div>
    {% endif %}
</div>
{% if screenshots %}
  <div class="screenshots-background" data-igdb-id="{{ source_id }}">
  <div class="screenshot-rotator" onmouseenter="showArrows(this)" onmouseleave="hideArrows(this)">
    <img id="screenshot-image" src="{{ screenshots.0.url }}" alt="Screenshot" />
    <button class="rotator-btn left" onclick="changeScreenshot(-1)" style="display: none;">‹</button>
    <button class="rotator-btn right" onclick="changeScreenshot(1)" style="display: none;">›</button>
    {% if not recommendations %}
    <button class="delete-screenshot-btn" onclick="deleteScreenshot('{{ shot.url }}')">×</button>
    {% endif %}
  </div>

  <div class="screenshots-list">
    {% for shot in screenshots %}
      <img 
        src="{{ shot.url }}" 
        alt="Screenshot {{ forloop.counter }}" 
        class="thumbnail {% if forloop.first %}active-thumbnail{% endif %}" 
        onclick="setScreenshot({{ forloop.counter0 }})" 
      />
    {% endfor %}
  </div>
  </div>
  {{ screenshots|json_script:"screenshots-data" }}
{% endif %}
</section>
{% endif %}

{% if cast %}
<section class="cast-section">
  <div class="cast-header">
    {% if media_type == "tv" or media_type == "movie" %}
    <h2>Cast</h2>
    {% elif media_type == "manga" or media_type == "anime" %}
    <h2>Characters</h2>
    {% elif media_type == "book" %}
    <h2>Authors</h2>
    {% else %}
    <h2>Cast</h2>
    {% endif %}
    
    <div class="cast-controls">
      <div class="search-container">
        <button id="search-toggle-btn" class="search-toggle">
          <svg class="cast-search-icon" width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128
                     C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3
                     c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3
                     c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128
                     0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128
                     0 70.7-57.2 128-128 128z"></path>
          </svg>
        </button>
        <input type="text" id="person-search-input" placeholder="Search.." autocomplete="off" class="search-input hidden">
      </div>
      
      {% if cast|length >= 8 %}
      <button id="load-more-cast" class="load-more-btn" 
              data-source="{{ source }}" 
              data-source-id="{{ source_id }}" 
              data-media-type="{{ media_type }}" 
              data-page="1">Load More</button>
      {% endif %}
    </div>
  </div>

  <!-- Search results above the cast list -->
  <div id="person-search-results" class="search-results"></div>

  <div class="cast-list">
    {% for member in cast %}
    {% if member.id %}
      {% if media_type == "tv" or media_type == "movie" %}
        <a href="/person/actor/{{ member.id }}/" class="cast-member">
      {% elif media_type == "manga" or media_type == "anime" %}
        <a href="/person/character/{{ member.id }}/" class="cast-member">
      {% else %}
        <div class="cast-member">
      {% endif %}
        <img src="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}"
             alt="{{ member.name }}"
             data-placeholder="{% static 'core/img/placeholder.png' %}"
             onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
        {% if media_type == 'anime' or media_type == 'manga' %}
          <p class="actor-name">{{ member.name }}</p>
        {% else %}
          <p class="actor-name">{{ member.name }}</p>
          <p class="character-name">{{ member.character }}</p>
        {% endif %}
        <label class="cast-favorite" data-name="{{ member.name }}" data-img="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}" data-type="{% if media_type == 'anime' or media_type == 'manga' %}character{% else %}actor{% endif %}" data-id="{{ member.id|default:'' }}">
          <input type="checkbox">
          <span class="heart"></span>
        </label>
      {% if media_type == "tv" or media_type == "movie" or media_type == "manga" or media_type == "anime" %}
        </a>
      {% else %}
        </div>
      {% endif %}
    {% else %}
      <div class="cast-member">
        <img src="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}"
             alt="{{ member.name }}"
             data-placeholder="{% static 'core/img/placeholder.png' %}"
             onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
        <p class="actor-name">{{ member.name }}</p>
        <p class="character-name">{{ member.character }}</p>
        <label class="cast-favorite" data-name="{{ member.name }}" data-img="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}" data-type="{% if media_type == 'anime' or media_type == 'manga' %}character{% else %}actor{% endif %}" data-id="">
          <input type="checkbox">
          <span class="heart"></span>
        </label>
      </div>
    {% endif %}
    {% endfor %}
  </div>
  

</section>
{% endif %}

{% if recommendations %}
<section class="recommendations-section">
  <h2>Recommendations</h2>
  <div class="recommendations-list">
    {% for rec in recommendations %}
    <div class="recommendation">
    <a href="
      {% if media_type == 'game' %}
        /igdb/game/{{ rec.id }}/
      {% elif media_type == 'anime' or media_type == 'manga' %}
        /mal/{{ media_type }}/{{ rec.id }}/
      {% elif media_type == 'book' %}
        /openlib/book/{{ rec.id }}/
      {% else %}
        /tmdb/{{ media_type }}/{{ rec.id }}/
      {% endif %}
    " title="{{ rec.title }}">
      
      {% if rec.poster_path %}
<img
  src="{% if media_type == 'game' or media_type == 'anime' or media_type == 'manga' %}
        {{ rec.poster_path }}
       {% else %}
        https://image.tmdb.org/t/p/w185{{ rec.poster_path }}
       {% endif %}"
  alt="{{ rec.title }}"
  data-placeholder="{% static 'core/img/placeholder.png' %}"
  onerror="this.onerror=null;this.src=this.dataset.placeholder;"
/>
      {% else %}
        <img 
  src="{% static 'core/img/placeholder.png' %}" 
  alt="{{ rec.title }}" 
/>
      {% endif %}
      
      <p class="rec-title">{{ rec.title }}</p>
    </a>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}


  </div>
</div>
{% endblock %}

{% block script %}
  {{ block.super }}
  <script src="{% static 'core/js/detail.js' %}?v={{ version }}"></script>
  <script src="{% static 'core/js/edit_modal.js' %}?v={{ version }}"></script>
{% endblock %}
{% extends "core/base.html" %}
{% load static %}

{% block head %}
  {{ block.super }}
  <title>{{ title }} - Media Journal</title>
  <link rel="stylesheet" href="{% static 'core/css/detail.css' %}?v={{ version }}" />
  <link rel="stylesheet" href="{% static 'core/css/modal.css' %}?v={{ version }}" />
{% endblock %}

{% block content %}
<body data-media-type="{{ media_type }}"></body>
<script>
  document.body.dataset.theme = '{{ theme_mode }}';
  document.body.dataset.mediaType = '{{ media_type }}';
  document.body.dataset.itemId = '{{ source_id }}';
  {% if media_type == 'music' %}
  document.body.dataset.artistId = '{{ artist_id|default:"" }}';
  document.body.dataset.albumId = '{{ album_id|default:"" }}';
  {% endif %}
</script>

{% with banner=banner_url|default_if_none:'' %}
  <div class="banner-section {% if not banner %}no-banner{% endif %}"
       {% if banner %}data-banner="{{ banner_url}}"{% endif %}>
    <div class="banner-overlay"></div>
  </div>
{% endwith %}

<!-- Colored section below banner -->
<div class="top-colored-section">
  <div class="detail-container top-content">

  <div class="left-column">
    <!-- Poster -->
<img class="poster" 
     src="{{ poster_url }}" 
     alt="{{ title }}" 
     data-placeholder="{% static 'core/img/placeholder.png' %}" 
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
    
    <!-- Edit / Favorite buttons -->
    <div class="edit-favorite-wrapper">
      {% if in_my_list %}
        <button id="edit-button" class="btn edit-card-btn" data-id="{{ item_id }}" data-media-type="{{ media_type }}" data-source-id="{{ source_id }}">Edit</button>
        <form id="favorite-form" data-item-id="{{ item_id }}">
          <label class="favorite-checkbox">
            <input type="checkbox" name="favorite" {% if item.favorite %}checked{% endif %}>
            <span class="heart"></span>
          </label>
        </form>
        <button class="settings-cogwheel-btn" onclick="toggleSettingsDropdown(event)">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
          </svg>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button onclick="openBannerUpload('{{ source }}', '{{ source_id }}')" class="dropdown-item">Change Banner</button>
          <button onclick="openCoverUpload('{{ source }}', '{{ source_id }}')" class="dropdown-item">Change Cover</button>
          <button onclick="refreshItem('{{ item_id }}', 'data')" class="dropdown-item" title="Only data (not the cover, banner, screenshots, or videos).">Refresh Data</button>
          <button onclick="refreshItem('{{ item_id }}', 'all')" class="dropdown-item" title="Only data, cover, and banner (not screenshots or videos).">Refresh Data & Images</button>
          <button onclick="refreshItem('{{ item_id }}', 'banner')" class="dropdown-item" title="Only the banner.">Refresh Banner</button>
          <button onclick="refreshItem('{{ item_id }}', 'cover')" class="dropdown-item" title="Only the cover.">Refresh Cover</button>
        </div>
      {% else %}
        <button id="add-to-list-button" class="btn"
          data-source="{{ source }}"
  data-source-id="{{ source_id }}"
  data-media-type="{{ media_type }}"
  data-title="{{ title }}"
  data-cover-url="{{ cover_url }}">Add to My List</button>
      {% endif %}
    </div>
  </div>

<div class="right-column">
  <div class="text-info">
    <h1>{{ title }}</h1>
    <div class="overview-container">
      <p class="overview">{{ overview|safe|linebreaksbr }}</p>
      <button class="read-more-btn">Read More</button>
    </div>
    <p class="release-date">{{ release_date }}</p>

    <!-- More info button -->
    {% if media_type != "book" %}
    <button id="more-info-btn" class="more-info-btn">More information</button>
    {% endif %}
    <!-- Container for extra info -->
    <div id="extra-info-container" style="margin-top:0.5em;"></div>
  </div>
</div>
  </div>
 </div>
</div>


{% include "core/partials/edit_modal.html" with media_type=media_type item_id=item_id status=item.status personal_rating=item.personal_rating notes=item.notes progress_main=item.progress_main total_main=item.total_main progress_secondary=item.progress_secondary total_secondary=item.total_secondary favorite=item.favorite item_status_choices=item_status_choices item_rating_choices=item_rating_choices %}

<!-- Main background section -->
<div class="main-colored-section">
  <div class="detail-container">
    <div id="trailer-container" class="trailer-grid"></div>
    {% if prequels or sequels %}
    <section class="recommendations-section double-recs">
      {% if prequels %}
      <div class="rec-block">
        <h2>Prequel</h2>
        <div class="recommendations-list">
          {% for rec in prequels %}
          <a href="/mal/{{ media_type }}/{{ rec.id }}/" class="rec-card" title="{{ rec.title }}">
            <img src="{{ rec.poster_path }}"
     alt="{{ rec.title }}"
     data-placeholder="{% static 'core/img/placeholder.png' %}"
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
            <p class="rec-title">{{ rec.title }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if sequels %}
      <div class="rec-block">
        <h2>Sequel</h2>
        <div class="recommendations-list">
          {% for rec in sequels %}
          <a href="/mal/{{ media_type }}/{{ rec.id }}/" class="rec-card" title="{{ rec.title }}">
            <img src="{{ rec.poster_path }}" 
     alt="{{ rec.title }}" 
     data-placeholder="{% static 'core/img/placeholder.png' %}" 
     onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
            <p class="rec-title">{{ rec.title }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </section>
    {% endif %}

    {% if seasons %}
    <section class="seasons-section">
      <h2>Seasons</h2>
      <div class="seasons-list">
        {% for season in seasons %}
        <a href="/tmdb/season/{{ source_id }}/{{ season.season_number }}/" class="season-card">
  <img 
    src="{{ season.poster_path_full|default:'' }}"
    alt="{{ season.name }}"
    data-placeholder="{% static 'core/img/placeholder.png' %}"
    onerror="this.onerror=null;this.src=this.dataset.placeholder;"
  />
          <p class="season-name">{{ season.name }}</p>
          <p class="episode-count">{{ season.episode_count }} episodes</p>
          <p class="air-date">{{ season.air_date }}</p>
        </a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

{{ screenshots|json_script:"screenshots-data" }}

{% if media_type == 'music' %}
<section class="trailer-section music-section">
  <div class="music-header">
    <h2>Music</h2>
    <div class="music-controls">
      <label class="music-control-btn">
        <input type="checkbox" id="music-autoplay-toggle">
        <span>Autoplay</span>
      </label>
      <label class="music-control-btn">
        <input type="checkbox" id="music-hide-toggle">
        <span>Hide</span>
      </label>
      {% if in_my_list %}
      <button id="music-add-btn" class="music-control-btn">Add</button>
      {% endif %}
    </div>
  </div>
  <div id="music-add-form" class="music-add-form" style="display:none;">
    <input type="text" id="music-youtube-url" placeholder="Enter YouTube URL">
    <button id="music-save-btn">Save</button>
    <button id="music-cancel-btn">Cancel</button>
  </div>
  <div id="music-videos-container" class="trailer-grid">
    {% if youtube_links %}
    {% for link in youtube_links %}
      {% if 'youtube.com/watch?v=' in link.url %}
        <div class="music-video-wrapper" data-position="{{ link.position }}">
          <iframe
            src="https://www.youtube.com/embed/{{ link.url|slice:'32:' }}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            referrerpolicy="origin-when-cross-origin"
          ></iframe>
          {% if in_my_list %}
          <div class="music-video-controls">
            <button class="music-delete-btn" data-position="{{ link.position }}">‚úï</button>
            <button class="music-cover-btn" data-position="{{ link.position }}" title="Set as Cover">üñºÔ∏è</button>
            <button class="music-up-btn" data-position="{{ link.position }}" title="Move Up">‚ñ≤</button>
            <button class="music-down-btn" data-position="{{ link.position }}" title="Move Down">‚ñº</button>
          </div>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
    {% endif %}
  </div>
</section>
{% endif %}

{% if media_type == 'game' %}
<section class="screenshots-section">
  <div class="screenshots-header">
  <h2>Screenshots</h2>
{% if not recommendations %}
  <!-- Upload Form -->
   <div class="screenshots-header-buttons">
  <form id="screenshot-upload-form" enctype="multipart/form-data" class="inline-form">
    <input type="hidden" name="igdb_id" value="{{ source_id }}">
    <input type="file" id="screenshot-file-input" name="screenshots[]" accept=".jpg,.jpeg,.png" multiple hidden>
    <button type="button" id="swap-btn">
      Swap
    </button>
  </form>

  <!-- Add Form (add to existing) -->
<form id="screenshot-add-form" enctype="multipart/form-data" class="inline-form">
  <input type="hidden" name="igdb_id" value="{{ source_id }}">
  <input type="file" id="screenshot-add-file-input" name="screenshots[]" accept=".jpg,.jpeg,.png" multiple hidden>
  <button type="button" onclick="document.getElementById('screenshot-add-file-input').click();">
    Add
  </button>
</form>
</div>
    {% endif %}
</div>
{% if screenshots %}
  <div class="screenshots-background" data-igdb-id="{{ source_id }}">
  <div class="screenshot-rotator" onmouseenter="showArrows(this)" onmouseleave="hideArrows(this)">
    <img id="screenshot-image" src="{{ screenshots.0.url }}" alt="Screenshot" />
    <button class="rotator-btn left" onclick="changeScreenshot(-1)" style="display: none;">‚Äπ</button>
    <button class="rotator-btn right" onclick="changeScreenshot(1)" style="display: none;">‚Ä∫</button>
    {% if not recommendations %}
    <button class="autoplay-screenshot-btn" id="autoplay-screenshot-btn" title="Autoplay screenshots">
      <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </button>
    <button class="delete-screenshot-btn" onclick="deleteScreenshot('{{ shot.url }}')">√ó</button>
    {% endif %}
  </div>

  <div class="screenshots-list">
    {% for shot in screenshots %}
      <img 
        src="{{ shot.url }}" 
        alt="Screenshot {{ forloop.counter }}" 
        class="thumbnail {% if forloop.first %}active-thumbnail{% endif %}" 
        onclick="setScreenshot({{ forloop.counter0 }})" 
      />
    {% endfor %}
  </div>
  </div>
  {{ screenshots|json_script:"screenshots-data" }}
{% endif %}
</section>
{% endif %}

{% if cast %}
<section class="cast-section">
  <div class="cast-header">
    {% if media_type == "tv" or media_type == "movie" %}
    <h2>Cast</h2>
    {% elif media_type == "manga" or media_type == "anime" %}
    <h2>Characters</h2>
    {% elif media_type == "book" %}
    <h2>Authors</h2>
    {% else %}
    <h2>Cast</h2>
    {% endif %}
    
    <div class="cast-controls">
      <div class="search-container">
        <button id="search-toggle-btn" class="search-toggle">
          <svg class="cast-search-icon" width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128
                     C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3
                     c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3
                     c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128
                     0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128
                     0 70.7-57.2 128-128 128z"></path>
          </svg>
        </button>
        <input type="text" id="person-search-input" placeholder="Search.." autocomplete="off" class="search-input hidden">
      </div>
      
      {% if cast|length >= 8 %}
      <button id="load-more-cast" class="load-more-btn" 
              data-source="{{ source }}" 
              data-source-id="{{ source_id }}" 
              data-media-type="{{ media_type }}" 
              data-page="1">Load More</button>
      {% endif %}
    </div>
  </div>

  <!-- Search results above the cast list -->
  <div id="person-search-results" class="search-results"></div>

  <div class="cast-list">
    {% for member in cast %}
    {% if member.id %}
      {% if media_type == "tv" or media_type == "movie" %}
        <a href="/person/actor/{{ member.id }}/" class="cast-member">
      {% elif media_type == "manga" or media_type == "anime" %}
        <a href="/person/character/{{ member.id }}/" class="cast-member">
      {% else %}
        <div class="cast-member">
      {% endif %}
        <img src="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}"
             alt="{{ member.name }}"
             data-placeholder="{% static 'core/img/placeholder.png' %}"
             onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
        {% if media_type == 'anime' or media_type == 'manga' %}
          <p class="actor-name">{{ member.name }}</p>
        {% else %}
          <p class="actor-name">{{ member.name }}</p>
          <p class="character-name">{{ member.character }}</p>
        {% endif %}
        <label class="cast-favorite" data-name="{{ member.name }}" data-img="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}" data-type="{% if media_type == 'anime' or media_type == 'manga' %}character{% else %}actor{% endif %}" data-id="{{ member.id|default:'' }}">
          <input type="checkbox">
          <span class="heart"></span>
        </label>
      {% if media_type == "tv" or media_type == "movie" or media_type == "manga" or media_type == "anime" %}
        </a>
      {% else %}
        </div>
      {% endif %}
    {% else %}
      <div class="cast-member">
        <img src="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}"
             alt="{{ member.name }}"
             data-placeholder="{% static 'core/img/placeholder.png' %}"
             onerror="this.onerror=null;this.src=this.dataset.placeholder;" />
        <p class="actor-name">{{ member.name }}</p>
        <p class="character-name">{{ member.character }}</p>
        <label class="cast-favorite" data-name="{{ member.name }}" data-img="{% if member.is_full_url %}{{ member.profile_path }}{% else %}https://image.tmdb.org/t/p/w185{{ member.profile_path }}{% endif %}" data-type="{% if media_type == 'anime' or media_type == 'manga' %}character{% else %}actor{% endif %}" data-id="">
          <input type="checkbox">
          <span class="heart"></span>
        </label>
      </div>
    {% endif %}
    {% endfor %}
  </div>
  

</section>
{% endif %}

{% if recommendations %}
<section class="recommendations-section">
  <h2>Recommendations</h2>
  <div class="recommendations-list">
    {% for rec in recommendations %}
    <div class="recommendation">
    <a href="
      {% if media_type == 'game' %}
        /igdb/game/{{ rec.id }}/
      {% elif media_type == 'anime' or media_type == 'manga' %}
        /mal/{{ media_type }}/{{ rec.id }}/
      {% elif media_type == 'book' %}
        /openlib/book/{{ rec.id }}/
      {% else %}
        /tmdb/{{ media_type }}/{{ rec.id }}/
      {% endif %}
    " title="{{ rec.title }}">
      
      {% if rec.poster_path %}
<img
  src="{% if media_type == 'game' or media_type == 'anime' or media_type == 'manga' %}
        {{ rec.poster_path }}
       {% else %}
        https://image.tmdb.org/t/p/w185{{ rec.poster_path }}
       {% endif %}"
  alt="{{ rec.title }}"
  data-placeholder="{% static 'core/img/placeholder.png' %}"
  onerror="this.onerror=null;this.src=this.dataset.placeholder;"
/>
      {% else %}
        <img 
  src="{% static 'core/img/placeholder.png' %}" 
  alt="{{ rec.title }}" 
/>
      {% endif %}
      
      <p class="rec-title">{{ rec.title }}</p>
    </a>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}


  </div>
</div>
{% endblock %}

{% block script %}
  {{ block.super }}
  <script src="{% static 'core/js/detail.js' %}?v={{ version }}"></script>
  <script src="{% static 'core/js/edit_modal.js' %}?v={{ version }}"></script>
{% endblock %}